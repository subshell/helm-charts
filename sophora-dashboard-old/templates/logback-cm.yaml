apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "sophora-dashboard-old.fullname" . }}-logback
  labels:
    {{- include "sophora-dashboard-old.labels" . | nindent 4 }}
data:
  logback.xml: |
    <?xml version="1.0" encoding="UTF-8" ?>

    <configuration scan="true" scanPeriod="10 seconds">
      <jmxConfigurator />

      <!-- Propagate level settings to java.util.logging. -->
      <contextListener class="ch.qos.logback.classic.jul.LevelChangePropagator" />

      <property name="PATTERN" value="%d{HH:mm:ss} %-5level [%thread] [%X] %logger{0}:%L: %m%n" />
     	<appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
    		<encoder>
    			<pattern>[%d{"yyyy-MM-dd HH:mm:ss.SSSX",UTC}, %-5p] [%thread] %-5level %.40c:%L - %msg %n</pattern>
    		</encoder>
    	</appender>
      <appender name="logfile" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <File>logs/dashboard.log</File>

        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
          <fileNamePattern>logs/dashboard.%d{yyyy-MM-dd}.log.gz</fileNamePattern>
          <maxHistory>7</maxHistory>
        </rollingPolicy>
        <encoder>
          <pattern>${PATTERN}</pattern>
        </encoder>
      </appender>

      <appender name="warnlog" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <filter class="ch.qos.logback.classic.filter.ThresholdFilter">
          <level>WARN</level>
        </filter>

        <File>logs/dashboard_warn.log</File>

        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
          <fileNamePattern>logs/dashboard_warn.%d{yyyy-MM-dd}.log.gz</fileNamePattern>
          <maxHistory>7</maxHistory>
        </rollingPolicy>
        <encoder>
          <pattern>${PATTERN}</pattern>
        </encoder>
      </appender>

      <appender name="jetty" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>logs/dashboard_request.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
          <fileNamePattern>logs/dashboard_request.%d{yyyy-MM-dd}.log.gz</fileNamePattern>
          <maxHistory>30</maxHistory>
        </rollingPolicy>
        <encoder>
          <pattern>%-4relative [%thread] %-5level %logger{35} - %msg%n</pattern>
        </encoder>
      </appender>

      <logger name="com.subshell.sophora" level="INFO" />
      <logger name="org.springframework" level="WARN" />
      <!-- Suppress warnings from the RestTemplate. It will throw an exception anyway. -->
      <logger name="org.springframework.web.client.RestTemplate" level="ERROR" />
      <logger name="org.eclipse.jetty" level="WARN" />

      <logger name="org.eclipse.jetty.server.RequestLog" level="INFO" additivity="false">
        <appender-ref ref="jetty" />
      </logger>

      <root level="WARN">
    	<appender-ref ref="logfile" />
      </root>

    </configuration>