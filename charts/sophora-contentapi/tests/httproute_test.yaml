suite: test httproute
templates:
  - httproute.yaml
tests:
  - it: should not create httproute by default
    asserts:
      - hasDocuments:
          count: 0

  - it: should create httproute when enabled
    set:
      httpRoute.enabled: true
      httpRoute.parentRefs[0].name: my-gateway
      httpRoute.hostnames[0]: contentapi.example.com
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: HTTPRoute
      - equal:
          path: metadata.name
          value: RELEASE-NAME-sophora-contentapi

  - it: should use custom fullnameOverride
    set:
      fullnameOverride: my-httproute
      httpRoute.enabled: true
      httpRoute.parentRefs[0].name: my-gateway
    asserts:
      - equal:
          path: metadata.name
          value: my-httproute

  - it: should configure parentRefs
    set:
      httpRoute.enabled: true
      httpRoute.parentRefs[0].name: my-gateway
      httpRoute.parentRefs[0].namespace: gateway-ns
    asserts:
      - equal:
          path: spec.parentRefs[0].name
          value: my-gateway
      - equal:
          path: spec.parentRefs[0].namespace
          value: gateway-ns

  - it: should configure multiple parentRefs
    set:
      httpRoute.enabled: true
      httpRoute.parentRefs[0].name: gateway-1
      httpRoute.parentRefs[1].name: gateway-2
    asserts:
      - equal:
          path: spec.parentRefs[0].name
          value: gateway-1
      - equal:
          path: spec.parentRefs[1].name
          value: gateway-2

  - it: should configure hostnames
    set:
      httpRoute.enabled: true
      httpRoute.parentRefs[0].name: my-gateway
      httpRoute.hostnames[0]: contentapi1.example.com
      httpRoute.hostnames[1]: contentapi2.example.com
    asserts:
      - contains:
          path: spec.hostnames
          content: contentapi1.example.com
      - contains:
          path: spec.hostnames
          content: contentapi2.example.com

  - it: should not have hostnames when not configured
    set:
      httpRoute.enabled: true
      httpRoute.parentRefs[0].name: my-gateway
    asserts:
      - notExists:
          path: spec.hostnames

  - it: should configure backendRefs with correct service
    set:
      httpRoute.enabled: true
      httpRoute.parentRefs[0].name: my-gateway
    asserts:
      - equal:
          path: spec.rules[0].backendRefs[0].name
          value: RELEASE-NAME-sophora-contentapi
      - equal:
          path: spec.rules[0].backendRefs[0].port
          value: 8080

  - it: should use custom service port
    set:
      httpRoute.enabled: true
      httpRoute.parentRefs[0].name: my-gateway
      service.port: 9090
    asserts:
      - equal:
          path: spec.rules[0].backendRefs[0].port
          value: 9090

  - it: should configure matches
    set:
      httpRoute.enabled: true
      httpRoute.parentRefs[0].name: my-gateway
      httpRoute.matches[0].path.type: PathPrefix
      httpRoute.matches[0].path.value: /api
    asserts:
      - equal:
          path: spec.rules[0].matches[0].path.type
          value: PathPrefix
      - equal:
          path: spec.rules[0].matches[0].path.value
          value: /api

  - it: should configure multiple matches
    set:
      httpRoute.enabled: true
      httpRoute.parentRefs[0].name: my-gateway
      httpRoute.matches[0].path.type: PathPrefix
      httpRoute.matches[0].path.value: /api
      httpRoute.matches[1].path.type: Exact
      httpRoute.matches[1].path.value: /health
    asserts:
      - equal:
          path: spec.rules[0].matches[0].path.value
          value: /api
      - equal:
          path: spec.rules[0].matches[1].path.value
          value: /health

  - it: should not have matches when not configured
    set:
      httpRoute.enabled: true
      httpRoute.parentRefs[0].name: my-gateway
    asserts:
      - notExists:
          path: spec.rules[0].matches

  - it: should configure filters
    set:
      httpRoute.enabled: true
      httpRoute.parentRefs[0].name: my-gateway
      httpRoute.filters[0].type: RequestHeaderModifier
      httpRoute.filters[0].requestHeaderModifier.set[0].name: X-Custom-Header
      httpRoute.filters[0].requestHeaderModifier.set[0].value: custom-value
    asserts:
      - equal:
          path: spec.rules[0].filters[0].type
          value: RequestHeaderModifier
      - equal:
          path: spec.rules[0].filters[0].requestHeaderModifier.set[0].name
          value: X-Custom-Header
      - equal:
          path: spec.rules[0].filters[0].requestHeaderModifier.set[0].value
          value: custom-value

  - it: should not have filters when not configured
    set:
      httpRoute.enabled: true
      httpRoute.parentRefs[0].name: my-gateway
    asserts:
      - notExists:
          path: spec.rules[0].filters

  - it: should configure annotations
    set:
      httpRoute.enabled: true
      httpRoute.parentRefs[0].name: my-gateway
      httpRoute.annotations.custom: annotation
      httpRoute.annotations.another: value
    asserts:
      - equal:
          path: metadata.annotations.custom
          value: annotation
      - equal:
          path: metadata.annotations.another
          value: value

  - it: should not have annotations when not configured
    set:
      httpRoute.enabled: true
      httpRoute.parentRefs[0].name: my-gateway
    asserts:
      - notExists:
          path: metadata.annotations

  - it: should have correct labels
    set:
      httpRoute.enabled: true
      httpRoute.parentRefs[0].name: my-gateway
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: sophora-contentapi
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: RELEASE-NAME
      - matchRegex:
          path: metadata.labels["helm.sh/chart"]
          pattern: ^sophora-contentapi-

  - it: should create httproute with all custom values
    values:
      - ./values/httproute-custom.yaml
    asserts:
      - equal:
          path: metadata.name
          value: custom-route
      - equal:
          path: spec.parentRefs[0].name
          value: custom-gateway
      - contains:
          path: spec.hostnames
          content: custom.example.com
      - equal:
          path: spec.rules[0].matches[0].path.value
          value: /custom
      - equal:
          path: metadata.annotations.custom
          value: annotation
